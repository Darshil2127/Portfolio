@app.route('/dashboard', methods=['GET', 'POST'])
def dashboard():
    if request.method == 'POST':
        file = request.files['file']
        if file:
            df = pd.read_csv(file)

            # Check required columns
            if not {'Ticker', 'Quantity', 'Buy Price'}.issubset(df.columns):
                return "Invalid CSV format", 400

            portfolio = []
            total_invested = 0
            current_value = 0

            for _, row in df.iterrows():
                ticker = row['Ticker']
                quantity = int(row['Quantity'])
                buy_price = float(row['Buy Price'])

                # Fetch current price from Alpha Vantage
                price_url = f'https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol={ticker}&apikey={ALPHA_VANTAGE_KEY}'
                response = requests.get(price_url).json()
                try:
                    current_price = float(response['Global Quote']['05. price'])
                except:
                    current_price = 0.0

                total_value = quantity * current_price
                invested = quantity * buy_price

                # AI-based suggestion logic
                suggestion = "BUY" if current_price < buy_price else "SELL"

                portfolio.append({
                    "ticker": ticker,
                    "quantity": quantity,
                    "buy_price": round(buy_price, 2),
                    "current_price": round(current_price, 2),
                    "total_value": round(total_value, 2),
                    "ai_suggestion": suggestion
                })

                total_invested += invested
                current_value += total_value

            gain_loss = round(current_value - total_invested, 2)

            # Render the dashboard template with the correct variables
            return render_template('dashboard.html', portfolio=portfolio,
                                   total_invested=total_invested,
                                   current_value=current_value,
                                   gain_loss=gain_loss)

    return render_template("dashboard.html", portfolio=None)
