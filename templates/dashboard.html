<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FinFuse Portfolio Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="refresh" content="300" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body class="light-mode">

<div id="dashboard" class="dashboard-wrapper">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-left">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="FinFuse Logo" class="logo-img">
      <h1>FinFuse Portfolio Dashboard</h1>
    </div>
    <div class="header-right">
      <button onclick="downloadPDF()">Export to PDF</button>
      <button onclick="toggleDarkMode()" id="darkToggle">ðŸŒ™</button>
    </div>
  </div>

  <!-- Summary -->
  <div class="summary">
    <p><strong>Total Invested:</strong> ${{ invested | default(0) | round(2) }}</p>
    <p><strong>Current Value:</strong> ${{ current | default(0) | round(2) }}</p>
    <p><strong>Gain/Loss:</strong>
      <span style="color: {{ 'green' if gain > 0 else 'red' if gain < 0 else 'black' }};">
        ${{ gain | default(0) | round(2) }}
      </span>
    </p>
  </div>

  <!-- Portfolio Table -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Ticker</th>
          <th>Quantity</th>
          <th>Buy Price</th>
          <th>Current Price</th>
          <th>Total Value</th>
          <th>AI Suggestion</th>
          <th>AI Reason</th>
        </tr>
      </thead>
      <tbody>
        {% for stock in portfolio %}
        <tr>
          <td><a href="https://finance.yahoo.com/quote/{{ stock['Ticker'] }}" target="_blank">{{ stock['Ticker'] }}</a></td>
          <td>{{ stock['Quantity'] }}</td>
          <td>${{ stock['Buy Price'] }}</td>
          <td>${{ stock['Current Price'] | round(2) }}</td>
          <td>${{ stock['Total Value'] | round(2) }}</td>
          <td style="color: {% if stock['AI Suggestion'] == 'BUY' %}green{% elif stock['AI Suggestion'] == 'SELL' %}red{% else %}gray{% endif %};">
            {{ stock['AI Suggestion'] }}
          </td>
          <td>{{ stock['AI Reason'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Uploaded News -->
  <h2>ðŸ“° Latest News Related to Your Stocks</h2>
  {% for article in news %}
    <div class="news-card">
      <h3>{{ article['title'] }}</h3>
      <p>{{ article['description'][:150] }}...</p>
      <a href="{{ article['url'] }}" target="_blank">Read More</a>
    </div>
  {% endfor %}

  <!-- Live Auto-Refreshing News -->
  <h2>âš¡ Live Market News (Auto-refreshes)</h2>
  <div id="live-news"></div>
</div>

<!-- Scripts -->
<script>
function downloadPDF() {
  const dashboard = document.getElementById("dashboard");
  html2canvas(dashboard).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jspdf.jsPDF("p", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const imgWidth = pageWidth - 20;
    const imgHeight = canvas.height * imgWidth / canvas.width;
    pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
    pdf.save("FinFuse-Portfolio.pdf");
  });
}

function toggleDarkMode() {
  const body = document.body;
  body.classList.toggle("dark-mode");
  const isDark = body.classList.contains("dark-mode");
  document.getElementById("darkToggle").textContent = isDark ? "â˜€" : "ðŸŒ™";
}

function fetchLiveNews() {
  fetch("/api/news")
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("live-news");
      container.innerHTML = "";
      const seen = new Set();
      data.news.forEach(article => {
        const key = article.title || article.url;
        if (seen.has(key)) return;
        seen.add(key);
        const tag = article.entities?.[0]?.type?.toUpperCase() || "NEWS";
        const div = document.createElement("div");
        div.className = "news-card";
        div.innerHTML = `
          <div class="news-tag">${tag}</div>
          <h4>${article.title}</h4>
          <p>${article.description?.slice(0, 150)}...</p>
          <a href="${article.url}" target="_blank">Read More</a>
        `;
        container.appendChild(div);
      });
    })
    .catch(err => console.error("News fetch failed:", err));
}

fetchLiveNews();
setInterval(fetchLiveNews, 30000);
</script>

</body>
</html>
